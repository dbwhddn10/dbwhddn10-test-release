name: NPM Publish
on: push
jobs:
  publish:
    name: publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Codes
        id: "checkout"
        uses: actions/checkout@v3
      - name: Run Publish
        id: "run"
        uses: actions/github-script@v7
        with:
          script: |
            const package = require('./package.json');
            const childProcess = require('node:child_process');
            const currentVersion = package.version;
            const branch = childProcess.execSync('git symbolic-ref --short HEAD').toString().trim();
            const oldVersions = JSON.parse(childProcess.execSync('npm view '+ package.name +' versions').toString().replaceAll('\'', '"'));
            const isPublished = oldVersions.includes(currentVersion);
            if (branch == 'main' || branch == 'master') {
              package.publishTag = 'latest';
            } else if (branch.match(/(\d+\.|)\d+/)) {
              package.publishTag = 'v'+branch.match(/(\d+\.|)\d+/)?.[0]+'-lts';
            } else {
              throw new Error('`publishTag` is not define.');
            }
            if (!isPublished) {
              childProcess.execSync('npm publish ./dist --access public --tag '+ package.publishTag);
            }
